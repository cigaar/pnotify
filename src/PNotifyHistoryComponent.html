<svelte:options accessors={true} />
<script context="module">
  import { defaultStack, notices } from './PNotifyCore';

  export const key = 'History';

  export const defaults = {
    // Place the notice in the history.
    history: true,
    // Maximum number of notices to have open in its stack.
    maxInStack: Infinity
  };

  export function showLast (stack) {
    if (stack === undefined) {
      stack = defaultStack;
    }
    if (stack === false) {
      return;
    }
    const top = (stack.push === 'top');

    // Look up the last history notice, and display it.
    let i = (top ? 0 : notices.length - 1);

    let notice;
    do {
      notice = notices[i];

      if (!notice) {
        return;
      }

      i += (top ? 1 : -1);
    } while (
      notice.stack !== stack ||
      !notice.getModuleAccessors().History.history ||
      notice.getState() === 'opening' ||
      notice.getState() === 'open'
    );

    notice.open();
  }

  export function showAll (stack) {
    if (stack === undefined) {
      stack = defaultStack;
    }
    if (stack === false) {
      return;
    }

    // Display all notices. (Disregarding non-history notices.)
    for (let i = 0; i < notices.length; i++) {
      const notice = notices[i];
      if (
        (
          stack === true ||
          notice.stack === stack
        ) &&
        notice.getModuleAccessors().History.history
      ) {
        notice.open();
      }
    }
  }
</script>
<script>
  // The PNotify notice.
  export let _notice = null;

  export let history = defaults.history;
  export let maxInStack = defaults.maxInStack;

  $: {
    if (history && _notice.destroy) {
      // Don't destroy notices that are in history.
      _notice.destroy = false;
    }
  }

  export function beforeOpen () {
    if (maxInStack === Infinity) {
      return;
    }

    const stack = _notice.stack;
    if (stack === false) {
      return;
    }

    // Remove oldest notifications leaving only maxInStack from the stack.
    if (notices && (notices.length > maxInStack)) {
      // Oldest are normally in front of array, or if stack.push=='top' then
      // they are at the end of the array!
      const top = stack.push === 'top';
      const forRemoval = [];
      let currentOpen = 0;

      for (let i = (top ? 0 : notices.length - 1); (top ? i < notices.length : i >= 0); (top ? i++ : i--)) {
        if (
          ['opening', 'open'].indexOf(notices[i].getState()) !== -1 &&
          notices[i].stack === stack
        ) {
          if (currentOpen >= maxInStack) {
            forRemoval.push(notices[i]);
          } else {
            currentOpen++;
          }
        }
      }

      for (let i = 0; i < forRemoval.length; i++) {
        forRemoval[i].close(false);
      }
    }
  }
</script>
